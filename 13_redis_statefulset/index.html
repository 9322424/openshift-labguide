<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Gourav Shah">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Creating Replicated Redis Cluster with Statefulsets - Openshift Tutorial</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Creating Replicated Redis Cluster with Statefulsets";
    var mkdocs_page_input_path = "13_redis_statefulset.md";
    var mkdocs_page_url = "/13_redis_statefulset/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', '', 'openshift-tutorial.schoolofdevops.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Openshift Tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Just Enough Docker</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../operating-containers/">Lab D101 - Operating Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../dockerizing-voteapp/">Lab D102 - Building and Publishing Docker Images</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-networking/">Lab D103 - Docker Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-volumes/">Lab D104 - Docker Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Lab K101 - Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../quickdive/">Lab K102 - Kubernetes Quickdive</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Lab K103 - Kubernetes LaunchPods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Lab K104 - Adding HA and Scalability with Replication Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Lab K105 - Load Balancing and Service Discovery with Services</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Openshift</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../oc-cluster-up/">Lab OC101 - Setting up Openshift Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../02_devops_php_app/">Lab OC102 - Deploying app from Openshift Console</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Lab OC103 - Defining Release Strategy with Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Lab OC104 - Peristent Volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Lab OC105 - Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Lab OC106 - Configurations Management with ConfigMaps</a>
                </li>
                <li class="">
                    
    <a class="" href="../helm/">Lab OC107 - Monitoring setup with HELM</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Administration</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Lab OC201 - Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Lab OC202 - Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Lab OC203 - Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Lab OC204 - Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Lab OC207 - Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Lab 208 - Cluster Administration</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Creating Replicated Redis Cluster with Statefulsets</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#deploying-redis-cluster-with-statefulsets">Deploying Redis Cluster with StatefulSets</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#redis-service">Redis Service</a></li>
        
            <li><a class="toctree-l4" href="#redis-configmap">Redis ConfigMap</a></li>
        
            <li><a class="toctree-l4" href="#redis-initcontainers">Redis initContainers</a></li>
        
            <li><a class="toctree-l4" href="#redis-statefulsets">Redis Statefulsets</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Exercises</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../xer-001-pods/">XER001 - Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Web Quests</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Openshift Tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Additional Topics &raquo;</li>
        
      
    
    <li>Creating Replicated Redis Cluster with Statefulsets</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/schoolofdevops/openshift-labguide/edit/chapters/manuscript/13_redis_statefulset.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="deploying-redis-cluster-with-statefulsets">Deploying Redis Cluster with StatefulSets</h1>
<p>What will you learn  </p>
<ul>
<li>Statefulsets  </li>
<li>initContainers</li>
</ul>
<h3 id="redis-service">Redis Service</h3>
<p>We will use Redis as Statefulsets for our Vote application.
It is similar to Deployment, but Statefulsets requires a <code>Service Name</code>.
So we will create a <code>headless service</code> (service without endpoints) first.</p>
<p><code>file: redis-svc.yml</code></p>
<pre><code>kind: Service
metadata:
  name: redis
  labels:
    app: redis
spec:
  type: ClusterIP
  ports:
  - name: redis
    port: 6379
    targetPort: redis
  clusterIP: None
  selector:
    app: redis
    role: master
</code></pre>

<p>apply</p>
<pre><code>kubectl apply -f redis-svc.yml
</code></pre>

<p><em>Note: clusterIP's value is set to None</em>.</p>
<h3 id="redis-configmap">Redis ConfigMap</h3>
<p>Redis ConfigMap has two sections.
  * master.conf - for Redis master
  * slave.conf - for Redis slave</p>
<p><code>file: redis-cm.yml</code></p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: redis
data:
  master.conf: |
    bind 0.0.0.0
    protected-mode yes
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    daemonize no
    supervised no
    pidfile /var/run/redis_6379.pid
    loglevel notice
    logfile &quot;&quot;
  slave.conf: |
    slaveof redis-0.redis 6379
</code></pre>

<p>apply</p>
<pre><code>kubectl apply -f redis-svc.yml
</code></pre>

<h3 id="redis-initcontainers">Redis initContainers</h3>
<p>We have to deploy redis master/slave set up from one statefulset cluster. This requires two different redis cofigurations , which needs to be described in one Pod template. This complexity can be resolved by using init containers. These init containers copy the appropriate redis configuration by analysing the hostname of the pod. If the Pod's (host)name has <code>0</code> as <strong>Ordinal number</strong>, then it is choosen as the master and master.conf is copied to /etc/ directory. Other Pods will get slave.conf as configuration.</p>
<p><code>file: redis-sts.yml</code></p>
<pre><code>[...]
      initContainers:
      - name: init-redis
        image: redis:4.0.9
        command:
        - bash
        - &quot;-c&quot;
        - |
          set -ex
          # Generate mysql server-id from pod ordinal index.
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          # Copy appropriate conf.d files from config-map to emptyDir.
          if [[ $ordinal -eq 0 ]]; then
            cp /mnt/config-map/master.conf /etc/redis.conf
          else
            cp /mnt/config-map/slave.conf /etc/redis.conf
          fi
        volumeMounts:
        - name: conf
          mountPath: /etc
          subPath: redis.conf
        - name: config-map
          mountPath: /mnt/config-map
</code></pre>

<h3 id="redis-statefulsets">Redis Statefulsets</h3>
<p>These redis containers are started after initContainers are succefully ran. One thing to note here, these containers mount the same volume, <code>conf</code>, from the initContainers which has the proper Redis configuration.</p>
<p><code>file: redis-sts.yaml</code></p>
<pre><code>[...]
      containers:
      - name: redis
        image: redis:4.0.9
        command: [&quot;redis-server&quot;]
        args: [&quot;/etc/redis.conf&quot;]
        env:
        - name: ALLOW_EMPTY_PASSWORD
          value: &quot;yes&quot;
        ports:
        - name: redis
          containerPort: 6379
        volumeMounts:
        - name: redis-data
          mountPath: /data
        - name: conf
          mountPath: /etc/
          subPath: redis.conf
</code></pre>

<p>To apply</p>
<pre><code>kubectl apply -f redis-sts.yml
</code></pre>

<h5 id="reading-list">Reading List</h5>
<ul>
<li><a href="https://redis.io/topics/replication">Redis Replication</a></li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/">Run Replicated Statefulsets Applications</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a></li>
</ul>
<p><strong>Search Keywords</strong></p>
<ul>
<li>init containers</li>
<li>kubernetes statefulsets</li>
<li>redis replication</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../vote-deployement_strategies/" class="btn btn-neutral float-right" title="Building Deployment Strategies">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cluster-administration/" class="btn btn-neutral" title="Lab 208 - Cluster Administration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/schoolofdevops/openshift-labguide/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../cluster-administration/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../vote-deployement_strategies/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
